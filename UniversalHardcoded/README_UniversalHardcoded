Liongard Agent Deployment - Universal Edition

ðŸ“– Overview

This script is the **Universal** solution for deploying the Liongard Agent. It is engineered to be **RMM-agnostic**, working flawlessly in ConnectWise Automate, Datto RMM, Kaseya VSA, NinjaOne, N-able, Syncro, or via Group Policy/PDQ Deploy.

**Context: Why use this version?**
Unlike "RMM-Specific" scripts that rely strictly on dynamic variables injected by the tool, this script is **flexible**. It prioritizes RMM parameters if available but falls back to **hardcoded credentials** inside the file if they are missing. This makes it the "Swiss Army Knife" of deployment scripts.

* **Best for:** Mixed environments, GPO deployments, "one-off" installs, or RMMs with complex variable handling.
* **Trade-off:** If you choose to hardcode credentials, you must create a separate copy of this script file for each Liongard environment you deploy to.

Key Features

* **Error Handling:** Parses MSI logs and translates generic error codes (1603, 1618, 1920) and **Security Blocks** (0x80070005) into plain English for your RMM dashboard.
* **Deep Clean Logic:** The Uninstaller Automatically hunts for and removes "ghost" registry keys (fixing Error 1612) and stuck "Rollback" scripts before installing.
* **Process Hygiene:** Proactively kills stuck `msiexec` processes to prevent "Installer Busy" failures.
* **Network Resilience:** Automatically retries downloads (3x) and enforces TLS 1.2/1.3 to bypass common SSL errors.
* **Zero Dependencies:** Smart URL handling and environment decoding mean it just works.

---

âš ï¸ Security & File Management (Read First)

**CRITICAL:** If you use the **Hardcoded Configuration** section, this script contains your Access Key Secrets. It must be treated as a sensitive credential file.

ðŸ›¡ï¸ Best Practices for IT Admins

1. **Naming Convention:** Use a clear naming convention to avoid mixing up credentials.
* *Bad:* `LiongardInstall.ps1`
* *Good:* `Liongard_Install_AcmeCorp_Hardcoded.ps1`


2. **Storage Location:**
* **Do not** store these scripts in a public folder or open network share (unless locked down for GPO).
* **Do not** upload the edited script to a public GitHub repository.


3. **Cleanup:** If running manually on an endpoint (e.g., via USB), **Shift+Delete** the script immediately after execution.

---

âš™ï¸ Configuration Guide

You have two ways to configure this script.

Method 1: RMM Parameters (Recommended)

Pass the credentials as arguments from your RMM script engine. The script accepts:
`-Url`, `-AccessKey`, `-AccessSecret`, `-Environment`

Method 2: Hardcoded (Standalone)

Edit the **Configuration Section** at the very top of the script (Lines 10-15).

1. Open `Install-Liongard-Universal.ps1` in a text editor (VS Code, Notepad++, or your RMM Script Editor).
2. Replace the placeholder text with your actual Liongard instance data.

```powershell
# =======================================================
# --- CONFIGURATION (HARDCODE VALUES HERE) ---
# =======================================================
$Hardcoded_Url          = "us1"                     # Subdomain is fine (e.g., "us1")
$Hardcoded_AccessKey    = "AKID1234567890"          # Your Liongard Access Key ID
$Hardcoded_AccessSecret = "SECRET1234567890ABCDEF"  # Your Liongard Access Key Secret
$Hardcoded_Environment  = "Managed Services"        # (Optional) The Environment Name

```

ðŸ’¡ Advanced Environment Naming

Liongard Environment names often contain spaces, ampersands (`&`), or commas. Passing these via command line can sometimes cause syntax errors.
To ensure 100% reliability, this script supports **URL Encoded** strings.

**Recommended Tool:** [Encode and Decode - Online](https://www.urlencoder.org/)

| Your Environment Name | Configuration Input (`$Environment`) | Status |
| --- | --- | --- |
| **Standard** (Finance Dept) | `$Environment = "Finance Dept"` | âœ… Works |
| **Encoded** (Finance%20Dept) | `$Environment = "Finance%20Dept"` | âœ… Works (Safest for RMMs) |
| **Complex** (Law & Order, LLC) | `$Environment = "Law%20%26%20Order%2C%20LLC"` | âœ… Works (Prevents syntax errors) |

---

ðŸš€ Deployment Scenarios

Scenario A: RMM Deployment (Preferred)

*Deploying via ConnectWise, Datto, Kaseya, Ninja, etc.*

* **Difficulty:** ðŸŸ¢ Easy
* **Pros:** Zero-touch; works over internet; logs capture specific failure reasons (e.g., "Security Blocked").
* **Steps:**
1. Upload the script to your RMM Library.
2. **Option A (Best):** Set up script variables in your RMM to pass `-Url`, `-AccessKey`, etc., as parameters.
3. **Option B (Hardcoded):** Duplicate the script for "Client A", hardcode their keys, and save it as "Liongard Install - Client A".
4. **Run As:** System or Administrator.



Scenario B: Group Policy (GPO) / PDQ Deploy

*Deploying via Active Directory GPO or local deployment tools.*

* **Difficulty:** ðŸ”´ Hard (Requires AD/Networking knowledge)
* **Pros:** Excellent for automatic onboarding of new domain devices.
* **Requirements:**
* **File Server:** Host the `.ps1` on a share (e.g., `\\YourDC\NETLOGON\`) accessible by **Domain Computers** (Read-Only).


* **Steps:**
1. Save the configured script to your network share.
2. Create a GPO linked to the target OU.
3. Navigate to: **Computer Configuration > Policies > Windows Settings > Scripts (Startup)**.
4. **PowerShell Scripts tab** > **Add** > Browse to the UNC path.
5. **Crucial:** Ensure the GPO is enforced and computers reboot to run the script.



Scenario C: Manual "One-Off" Installation

*Walking up to a machine or remote controlling it individually.*

* **Difficulty:** ðŸŸ¡ Medium (Manual Effort)
* **Pros:** Instant feedback; great for "Golden Image" prep or troubleshooting.
* **Steps:**
1. Copy the configured script to a temporary folder.
2. Right-click the file > **Run with PowerShell**.
3. Watch the console for the green "SUCCESS" message.
4. **Delete the script file immediately** to protect the embedded credentials.



---

ðŸ”§ Troubleshooting

This script is designed to be "noisy." If it fails, it will tell you exactly why in your RMM dashboard or local logs.

Log Locations (On the Endpoint)

1. **`C:\ProgramData\Liongard\ScriptInstall.log`**
* *Check here first.* Contains the logic flow (Download status, Pre-Flight checks, Deep Clean results).


2. **`C:\ProgramData\Liongard\AgentInstall.log`**
* *Check here for MSI errors.* The raw verbose log from the Windows Installer.



Common Translated Errors

The script parses cryptic codes into English. Here is what they mean:

| Error Output | Likely Cause | Solution |
| --- | --- | --- |
| **SECURITY BLOCK (0x80070005)** | ThreatLocker, SentinelOne, or AppLocker is blocking the MSI temp files. | Whitelist the **Liongard Inc.** certificate or enable Installation Mode. |
| **SERVICE FAILURE (1920)** | The Agent installed, but the Service refused to start. | Check AV Quarantine for `LiongardAgent.exe` or verify .NET Framework. |
| **INSTALLER BUSY (1618)** | Another installation (Windows Update) is running. | Wait 15 minutes and try again. |
| **REGISTRY CORRUPTION (1612)** | "Ghost" registry keys are confusing the installer. | The script attempted a **Deep Clean**. If it still fails, manual registry repair is needed. |
| **VERSION CONFLICT (1638)** | A newer version is already installed. | Uninstall the existing agent manually first. |

---

ðŸ“œ Uninstallation

To remove the agent, you do not need this script. You can simply run this command in PowerShell (Admin):

Get-Package -Name "Liongard Agent" | Uninstall-Package -Force
