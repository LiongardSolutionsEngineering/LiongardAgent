# Liongard Agent Deployment - NinjaOne Edition

## ðŸ“– Overview
This repository contains a production-ready PowerShell script designed to deploy the **Liongard Agent** via **NinjaOne (formerly NinjaRMM)**.

It is designed to be robust, secure, and "noisy" when it failsâ€”providing deep error analysis to help technicians troubleshoot immediately without guessing.

### Key Features
* **Enforced Inputs:** Friendly loop for humans (if run interactively), graceful exit for RMMs.
* **Race Condition Fix:** Waits for MSI logs to flush before analyzing exit codes.
* **Deep Error Analysis:** Parses MSI logs to explain failures (e.g., `401 Unauthorized`, `Invalid URL`).
* **NinjaOne Native:** Reads values directly from Ninja "Script Variables" (environment variables) to keep secrets out of the script body.
* **Smart URL Handling:** Automatically strips `https://` and appends `.app.liongard.com` if missing.

---

## ðŸ’¡ Smart Feature: URI Encoding Support
**Handling Special Characters in Environment Names**

If your Liongard Environment name contains spaces, ampersands (`&`), or commas (e.g., `Bruce & Wayne, LLP`), passing these via command line arguments can sometimes cause syntax errors in RMMs.

To prevent this, this script supports **URL Encoded** strings. You can safely use a tool like https://toolbox.googleapps.com/apps/encode_decode/(https://www.urlencoder.org/) to convert your Environment Name before pasting it into NinjaOne.

**How it works:**
1.  **You Provide:** `Bruce%20%26%20Wayne%2C%20LLP` (The "safe" encoded version).
2.  **Script Detects:** The script checks if the string is encoded.
3.  **Script Decodes:** It automatically converts it back to `Bruce & Wayne, LLP` inside the script logic.
4.  **Installer Receives:** The clean, correct name is passed to the MSI installer.

> **Note:** You do not *have* to encode the name. Standard text works fine for simple names. This is a fail-safe for complex names.

---

## ðŸš€ Setup Instructions

### 1. Prerequisites
Gather the following from your Liongard instance (**Admin > Account Settings > Access Tokens**):
* **Liongard URL** (e.g., `us1.app.liongard.com`)
* **Access Key ID**
* **Access Key Secret**

### 2. Configure in NinjaOne
1.  Navigate to **Administration > Library > Scripting**.
2.  Click **Create New Script**.
3.  **Language:** PowerShell | **OS:** Windows | **Architecture:** All.
4.  Paste the contents of `Liongard-Agent-Install.ps1` (found in this repo) into the editor.

### 3. Set Script Variables (Crucial)
You must define **Script Variables** in the NinjaOne editor so the script can receive your credentials securely. Add the following variables on the right-hand side:

| Variable Name | Type | Description |
| :--- | :--- | :--- |
| `liongardurl` | String | Your instance URL (e.g., `us1.app.liongard.com`) |
| `liongardaccesskey` | Secret | Your Liongard Access Key ID |
| `liongardaccesssecret` | Secret | Your Liongard Access Key Secret |
| `liongardenvironment` | String | (Optional) The Environment name. **Supports standard text OR URL Encoded text.** |

> **Note:** Variable names are case-insensitive, but we recommend using lowercase as shown above.

---

## ðŸ’» Usage

### Manual Run (Single Device)
1.  Select a device in NinjaOne.
2.  Click **Run Script** (Play button).
3.  Select this script from the library.
4.  **Run As:** `System`.
5.  Fill in the **Script Variables** prompt with your URL and Keys.
6.  Click **Run**.

### Automated Policy (Bulk Deployment)
1.  Go to **Administration > Policies > Agent Policies**.
2.  Select the target policy.
3.  Navigate to **Scheduled Scripts > Add a Scheduled Script**.
4.  Select this script.
5.  **Run As:** `System`.
6.  **Schedule:** Run Once (or Daily).
7.  **Script Variables:** Enter the credentials. You can also map these to *Organization Custom Fields* in Ninja for dynamic deployment across different clients.

---

## ðŸ”§ Troubleshooting

The script generates detailed logs to assist with debugging.

### Log Locations
* **Script Logic Log:** `C:\ProgramData\Liongard\ScriptInstall.log`
* **MSI Installer Log:** `C:\ProgramData\Liongard\AgentInstall.log`

### Common Errors
| Error | Cause | Solution |
| :--- | :--- | :--- |
| `FATAL ERROR: Missing required variables` | The Script Variables were left blank in Ninja. | Ensure `liongardurl`, `liongardaccesskey`, and `liongardaccesssecret` are populated in the Run window. |
| `Insufficient disk space` | Less than 200MB free on C:. | Free up space on the endpoint. |
| `Service installed but not running` | Credentials likely invalid. | Check `AgentInstall.log` for `INVALIDMSG`. Verify Access Key/Secret. |
